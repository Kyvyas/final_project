(function(){"use strict";TS.registerModule("rxns",{rxn_records_changed_sig:new signals.Signal,member_rxns_fetched_sig:new signals.Signal,member_rxns_being_fetched_sig:new signals.Signal,need_alerts:{},onStart:function(){if(!TS.client)return;if(!TS.boot_data.feature_reactions)return;_dispatchSignalThrottled=TS.utility.throttleFunc(_dispatchSignal,100);var _throttled_updateUI=TS.utility.throttleFunc(_updateUI,1e3);_updateUIThrottled=function(rxn_key){_throttled_updateUI(rxn_key)};var ls_rxn_records=TS.storage.fetchRxnRecords();if(parseInt(TS.qs_args.rxn_record_days)||!ls_rxn_records.length){TS.info("going to call _backFillRxnRecords because ls_rxn_records.length:"+ls_rxn_records.length);TS.ms.connected_sig.addOnce(_backFillRxnRecords)}else{_rxn_records=ls_rxn_records;for(var i=0;i<_rxn_records.length;i++){_rxn_records_map[_rxn_records[i].rxn_key]=_rxn_records[i]}}},upsertRxnsFromDataAndUpdateUI:function(rxn_key,rxns){var upsert=_upsertRxnsFromData(rxn_key,rxns);if(upsert.status!="NOOP"){_updateUIThrottled(rxn_key)}return upsert},getRxnKey:function(type,id,c_id){if(type=="message"&&!c_id)TS.error("getRxnKey: no c_id provided for message rxn_key");if(type!="message"&&c_id)TS.error("getRxnKey: c_id provided for but this is not a message rxn_key");return type+"-"+id+"-"+(c_id||"")},getRxnKeyByMsgType:function(msg){var rxn_key;if(msg.subtype=="file_upload"||msg.subtype=="file_share"||msg.subtype=="file_mention"){if(msg.file)rxn_key=msg.file._rxn_key}else if(msg.subtype=="file_comment"){if(msg.comment)rxn_key=msg.comment._rxn_key}else{rxn_key=msg._rxn_key}return rxn_key},getRxnKeyFromData:function(item){var id;if(item.type=="message"){id=item.ts||item.message.ts}else if(item.type=="file"){id=item.file.id||item.file}else if(item.type=="file_comment"){id=item.file_comment||item.comment.id}else{throw"item.type not handled"}return TS.rxns.getRxnKey(item.type,id,item.channel)},getExistingRxnsByKey:function(rxn_key){return _rxns[rxn_key]||null},getRxnRecordByKey:function(rxn_key){if(_rxn_records_map[rxn_key])return _rxn_records_map[rxn_key];for(var i=_rxn_records.length-1;i>-1;i--){if(_rxn_records[i].rxn_key===rxn_key){_rxn_records_map[rxn_key]=_rxn_records[i];return _rxn_records_map[rxn_key]}}return null},getNextRxnRecordThatNeedsAlert:function(){var candidate;for(var i=_rxn_records.length-1;i>-1;i--){if(TS.rxns.need_alerts[_rxn_records[i].rxn_key]){candidate=_rxn_records[i]}else{break}}return candidate},getRxnsFromData:function(item){if(item.type=="message")return item.message&&item.message.reactions&&item.message.reactions;if(item.type=="file")return item.file&&item.file.reactions&&item.file.reactions;if(item.type=="file_comment")return item.comment&&item.comment.reactions&&item.comment.reactions;return null},doesRxnsHaveRxnFromMember:function(rxns,name,member_id){name=TS.emoji.nameToCanonicalName(name);if(!rxns)return false;var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(!rxn)return false;if(!rxn)return false;if(!rxn.users)return false;return rxn.users.indexOf(member_id)!=-1},doesRxnsHaveRxnFromUser:function(rxns,name){return TS.rxns.doesRxnsHaveRxnFromMember(rxns,name,TS.model.user.id)},doesRxnsHaveRxn:function(rxns,name){if(!rxns)return false;return!!TS.rxns.getRxnFromRxns(rxns,name)},countAllRxns:function(rxns){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){t+=rxn.count||0});return t},countAllEmoji:function(rxns){if(!rxns)return 0;return rxns.length},countAllUsersRxns:function(rxns,user_id){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){if(rxn.users.indexOf(user_id)>-1){t++}});return t},getAllUniqueRxners:function(rxns,except){if(!rxns)return[];var rxners=[];rxns.forEach(function(rxn){if(!rxn)return;if(!rxn.count)return;if(!rxn.users)return;rxn.users.forEach(function(member_id){if(except==member_id)return;if(rxners.indexOf(member_id)!=-1)return;rxners.push(member_id)})});return rxners},getRxnFromRxns:function(rxns,name){if(!rxns)return null;return rxns.filter(function(val){return val.name==name})[0]||null},changeRxnsFromIMsg:function(imsg){if(!TS.boot_data.feature_reactions)return;if(!imsg.item)return;var simple_format=false;if(imsg.item.type=="message"&&imsg.item.ts){simple_format=true}else if(imsg.item.type=="file"&&typeof imsg.item.file=="string"){simple_format=true}else if(imsg.item.type=="file_comment"&&imsg.item.file_comment){simple_format=true}if(simple_format&&!_isReactionItemRelevant(imsg.item))return;var by_self=imsg.user==TS.model.user.id;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var new_rxns;if(simple_format){var adding=imsg.type=="reaction_added";new_rxns=_addOrRemoveRxnFromRxns(adding,TS.utility.clone(existing_rxns)||[],imsg.reaction,imsg.user)}else{new_rxns=TS.rxns.getRxnsFromData(imsg.item);if(by_self){}else{for(var k in existing_rxns){if(TS.rxns.doesRxnsHaveRxnFromUser(existing_rxns,k)){if(TS.utility.ensureInArray(existing_rxns[k].users,TS.model.user.id)){TS.warn('handleRxnChangeFromMS had to manually add the user to rxns "'+k+'" users')}}}}}var upsert=_upsertRxnsFromData(rxn_key,new_rxns);TS.dir(888,upsert,"handleRxnChangeFromMS upsert status:"+upsert.status);_maybeUpdateRxnRecords(imsg);if(upsert.status=="NOOP")return;if(by_self&&!imsg._from_evt_log){_updateUI(rxn_key,imsg.reaction,imsg.user)}else{_updateUIThrottled(rxn_key)}},changeRxnsFromUserAction:function(rxn_key,name,adding){name=TS.emoji.nameToCanonicalName(name);if(!TS.boot_data.feature_reactions)return;TS.log(888,"changeRxnsFromUserAction rxn_key:"+rxn_key+" name:"+name+" adding:"+adding);if(!TS.emoji.isValidName(name)){TS.error('"'+name+'" is not a valid emoji');return}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];if(adding){var emoji_cnt=TS.rxns.countAllEmoji(existing_rxns);var rxns_cnt=TS.rxns.countAllUsersRxns(existing_rxns,TS.model.user.id);if(emoji_cnt>=50){_displayTooManyError(TOO_MANY_EMOJI);return}else if(rxns_cnt>=10){_displayTooManyError(TOO_MANY_REACTIONS);return}}var new_rxns=_addOrRemoveUserRxnFromRxns(adding,TS.utility.clone(existing_rxns),name);TS.dir(888,existing_rxns,"existing_rxns");TS.dir(888,new_rxns,"new_rxns");var upsert=_upsertRxnsFromUserAction(rxn_key,new_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.error("changeRxnsFromUserAction called but no NOOP?");return}_updateUI(rxn_key,name,TS.model.user.id);var method=adding?"reactions.add":"reactions.remove";var api_args=_getApiArgsFromKey(rxn_key,{name:name});_incrementPendingCnt(rxn_key);TS.api.call(method,api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);var update_ui=false;if(ok){if(adding)TS.prefs.recordEmojiUse(":"+args.name+":")}else if(!adding&&data.error&&data.error=="no_reaction"){}else{if(data.error==TOO_MANY_EMOJI||data.error==TOO_MANY_REACTIONS){_displayTooManyError(data.error)}else if(data.error==INVALID_NAME){TS.generic_dialog.alert("Darn it, "+TS.emoji.graphicReplace(":"+args.name+":")+" doesn't work as a reaction yet! But rest assured, the full range of skin tones will be supported soon. We’re working on it!"+TS.emoji.graphicReplace(":wrench:"),"Invalid Emoji Name")}var current_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];var undone_rxns=_addOrRemoveUserRxnFromRxns(!adding,TS.utility.clone(current_rxns),name);var upsert=_upsertRxnsFromUserAction(rxn_key,undone_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction UNDO upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.log(888,"changeRxnsFromUserAction trying to undo because of API rsp, but no NOOP?")}else{update_ui=true}}var maybeUpdateModel=function(){TS.log(888,"maybeUpdateModel pending:"+_pending_counts[rxn_key]+" _pending_last:"+_pending_last[rxn_key]);if(_pending_counts[rxn_key])return false;if(!_pending_last.hasOwnProperty(rxn_key))return false;var upsert=_upsertRxnsFromUserAction(rxn_key,_pending_last[rxn_key]);delete _pending_last[rxn_key];TS.dir(888,upsert,"maybeUpdateModel status:"+upsert.status);if(upsert.status=="NOOP")return false;_updateUI(rxn_key);_fetchAndUpdateRxns(rxn_key);return true};if(!maybeUpdateModel()&&!update_ui)return;_updateUI(rxn_key)})},checkForRxnClick:function(e){if(!TS.boot_data.feature_reactions)return;if(!e||!e.target)return;var $el=$(e.target);var $emoji_rxn=$el.closest(".emoji_rxn");if(!$emoji_rxn.length)return;var name=String($emoji_rxn.data("emoji"));if($emoji_rxn.hasClass("emoji_rxn")){var $rxn_panel=$el.closest(".rxn_panel");var rxn_key=$rxn_panel.data("rxn-key");var adding;if($emoji_rxn.hasClass("menu_rxn")){TS.emoji_menu.startEmoForRxn(e,rxn_key)}else{adding=!$emoji_rxn.hasClass("user_reacted");if(!adding&&e.shiftKey){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);rxns.forEach(function(rxn){if(!TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name))return;TS.rxns.changeRxnsFromUserAction(rxn_key,rxn.name,adding)})}else{TS.rxns.changeRxnsFromUserAction(rxn_key,name,adding)}}}},getRxnRecords:function(){return _rxn_records},getRxnKeyParts:function(rxn_key){var keyA=rxn_key.split("-");return{type:keyA[0],id:keyA[1],c_id:keyA[2]}},test:function(){return{updateUI:_updateUI,addOrRemoveRxnFromRxns:_addOrRemoveRxnFromRxns,upsertRxnsFromData:_upsertRxnsFromData,upsertRxns:_upsertRxns,incrementPendingCnt:_incrementPendingCnt,decrementPendingCnt:_decrementPendingCnt,fetchAndUpdateRxns:_fetchAndUpdateRxns,backFillRxnRecords:_backFillRxnRecords,displayTooManyError:_displayTooManyError}}});var _rxn_records=[];var _rxn_records_map={};var _rxns={};var _pending_counts={};var _pending_last={};var _updateUI=function(rxn_key,name,member_id){var was_at_bottom=TS.client&&TS.client.ui&&TS.client.ui.areMsgsScrolledToBottom();TS.templates.builders.updateRxnPanels(rxn_key,name,member_id);if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(true)}};var _updateUIThrottled=function(rxn_key){_updateUI(rxn_key)};var _addOrRemoveUserRxnFromRxns=function(adding,rxns,name){return _addOrRemoveRxnFromRxns(adding,rxns,name,TS.model.user.id)};var _addOrRemoveRxnFromRxns=function(adding,rxns,name,member_id){var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(adding){if(!rxn){rxns.push({users:[member_id],count:1,name:name})}else{if(TS.utility.ensureInArray(rxn.users,member_id)){rxn.count++}else{}}}else{if(rxn){if(TS.utility.removeFromArray(rxn.users,member_id)){rxn.count--;if(rxn.count<1||rxn.users.length===0){TS.utility.removeFromArray(rxns,rxn)}if(!rxns.length){rxns=null}}else{}}else{}}return rxns};var _upsertRxnsFromUserAction=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,true)};var _upsertRxnsFromData=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,false)};var _upsertRxns=function(rxn_key,rxns,force){if(!TS.boot_data.feature_reactions)return;var upsert={status:"NOOP",what_changed:[],rxns:rxns};if(!force&&_pending_counts[rxn_key]){_pending_last[rxn_key]=TS.utility.clone(rxns||null);TS.log(888,"_upsertRxns call ignored because !force && _pending_counts["+rxn_key+"]:"+_pending_counts[rxn_key]);return upsert}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(rxns){if(existing_rxns){if(!TS.utility.areSimpleObjectsEqual(existing_rxns,rxns,"rxn_key:"+rxn_key)){upsert.status="CHANGED";_rxns[rxn_key]=rxns}}else{upsert.status="ADDED";_rxns[rxn_key]=rxns}}else if(existing_rxns){upsert.status="CHANGED";delete _rxns[rxn_key]}upsert.rxns=_rxns[rxn_key]||null;if(upsert.status!="NOOP"){if(key_parts.type=="message"){if(!key_parts.c_id)TS.error("_upsertRxns: no c_id provided but type is message");var model_ob=TS.shared.getModelObById(key_parts.c_id);var msg=model_ob&&TS.utility.msgs.getMsg(key_parts.id,model_ob.msgs);if(!msg){TS.dir(888,upsert.rxns,"_upsertRxns no need to update msg reactions key:"+rxn_key)}else{TS.dir(888,upsert.rxns,"_upsertRxns updated msg reactions key:"+rxn_key);TS.utility.msgs.maybeStoreMsgs(key_parts.c_id,model_ob.msgs,true)}}else if(key_parts.type=="file"){TS.files.makeSureReferencesGetSavedToLS(key_parts.id)}else if(key_parts.type=="file_comment"){TS.files.makeSureReferencesGetSavedToLS(key_parts.id)}else{throw"type not handled"}}TS.dir(888,upsert,rxn_key);return upsert};var _incrementPendingCnt=function(rxn_key){if(!rxn_key)return;_pending_counts[rxn_key]=_pending_counts[rxn_key]||0;_pending_counts[rxn_key]++;TS.log(888,"_incrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _decrementPendingCnt=function(rxn_key){if(!_pending_counts[rxn_key]){TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key]);return}_pending_counts[rxn_key]--;if(_pending_counts[rxn_key]===0){delete _pending_counts[rxn_key]}TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _getApiArgsFromKey=function(rxn_key,args){args=args||{};var key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(key_parts.type=="message"){args.channel=key_parts.c_id;args.timestamp=key_parts.id}else if(key_parts.type=="file"){args.file=key_parts.id}else if(key_parts.type=="file_comment"){args.file_comment=key_parts.id}else{throw"type not handled"}return args};var _fetchAndUpdateRxns=function(rxn_key,attempt){attempt=attempt||1;var max_attempts=2;var api_args=_getApiArgsFromKey(rxn_key,{full:true});TS.log(888,"_fetchAndUpdateRxns rxn_key:"+rxn_key+" attempt:"+attempt);_incrementPendingCnt(rxn_key);TS.api.call("reactions.get",api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);if(ok){var rxns=TS.rxns.getRxnsFromData(data);var upsert=_upsertRxnsFromData(rxn_key,rxns);TS.dir(888,upsert,"_fetchAndUpdateRxns upsert status:"+upsert.status);if(upsert.status=="NOOP")return;_updateUI(rxn_key)}else{TS.error("_fetchAndUpdateRxns got an err:"+JSON.stringify(data||null))}if(attempt<max_attempts){_fetchAndUpdateRxns(rxn_key,++attempt)}})};var _getRxnRecordEntryByNameAndMemberId=function(record,name,member_id){if(!record.emoji)return null;if(!record.emoji.hasOwnProperty(name))return null;for(var i=0;i<record.emoji[name].length;i++){if(record.emoji[name][i].id===member_id)return record.emoji[name][i]}return null};var _isImsgRelevantToRxnRecords=function(imsg){if(!TS.client)return false;if(imsg.user==TS.model.user.id)return false;if(imsg.item.type=="message"&&typeof imsg.item.message!=="undefined"&&imsg.item.message.user!=TS.model.user.id)return false;if(imsg.item.type=="file"&&typeof imsg.item.file!=="undefined"&&imsg.item.file.user!=TS.model.user.id)return false;if(imsg.item.type=="file_comment"&&typeof imsg.item.comment!=="undefined"&&imsg.item.comment.user!=TS.model.user.id)return false;return true};var _maybeUpdateRxnRecords=function(imsg){if(!_isImsgRelevantToRxnRecords(imsg))return;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);if(imsg.type=="reaction_added"){var and_alert=!imsg._from_evt_log&&imsg.item.type=="message";_addToRxnsRecord(imsg.reaction,rxn_key,imsg.user,imsg.event_ts,and_alert)}else{_removeFromRxnsRecord(imsg.reaction,rxn_key,imsg.user)}};var _isReactionItemRelevant=function(item){if(!item)return false;if(item.type=="message"){var msg=TS.utility.msgs.findMsg(item.ts,item.channel);if(!msg)return false;item.message=msg;return true}else if(item.type=="file"||item.type=="file_comment"){var file=TS.files.getFileById(item.file);if(!file)return false;item.file=file;if(item.type=="file_comment"){var comment=TS.files.getFileCommentById(file,item.file_comment);if(!comment)return false;item.comment=comment}return true}return false};var _addToRxnsRecord=function(name,rxn_key,member_id,when,and_alert){when=when||TS.utility.date.makeTsStamp();and_alert=!!and_alert;var added=false;var record=_rxn_records_map[rxn_key];if(!record){added=true;record=_rxn_records_map[rxn_key]=_rxn_records[_rxn_records.length]={rxn_key:rxn_key}}record.last_update=when;if(and_alert){TS.rxns.need_alerts[rxn_key]=TS.rxns.need_alerts[rxn_key]||when}record.emoji=record.emoji||{};var which=record.emoji[name]=record.emoji.hasOwnProperty(name)&&record.emoji[name]||[];var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id)||(which[which.length]={id:member_id});entry.when=when;TS.dir(877,_rxn_records,name+" "+rxn_key+" "+member_id);var len=_rxn_records.length;if(added&&len>1&&_rxn_records[len-1].last_update<_rxn_records[len-2].last_update){_rxn_records.sort(function compare(a,b){if(a.last_update<b.last_update)return-1;if(a.last_update>b.last_update)return 1;return 0})}_dispatchSignalThrottled(and_alert);var max=2e3;var storeable_rxn_records=_rxn_records.length>max?_rxn_records.slice(0,max):_rxn_records;TS.storage.storeRxnRecords(storeable_rxn_records)};var _dispatchSignal=function(and_alert){TS.rxns.rxn_records_changed_sig.dispatch(and_alert)};var _dispatchSignalThrottled=function(){_dispatchSignal()};var _removeFromRxnsRecord=function(name,rxn_key,member_id){var record=TS.rxns.getRxnRecordByKey(rxn_key);if(!record)return;var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id);if(!entry)return;TS.utility.removeFromArray(record.emoji[name],entry);if(!record.emoji[name].length){delete record.emoji[name]}if(!Object.keys(record.emoji).length){delete _rxn_records_map[rxn_key];TS.utility.removeFromArray(_rxn_records,record)}TS.rxns.rxn_records_changed_sig.dispatch();TS.storage.storeRxnRecords(_rxn_records)};var _temp_evt_log_events=[];var _onEventLog=function(ok,data,args){if(!ok){TS.error("_onEventLog "+data);return}if(!data.events){TS.error("_onEventLog missing events");return}var i;var imsg;for(i=0;i<data.events.length;i++){imsg=data.events[i];if(imsg.type!="reaction_added"&&imsg.type!="reaction_removed")continue;if(!_isImsgRelevantToRxnRecords(imsg))continue;imsg._from_evt_log=true;_temp_evt_log_events[_temp_evt_log_events.length]=imsg}TS.log(866,"LOADED _temp_evt_log_events.length: "+_temp_evt_log_events.length);if(data.has_more){_backFillRxnRecords(imsg.event_ts)}else{_updateUIThrottled.always_wait=true;_dispatchSignalThrottled.always_wait=true;TS.log(866,"_temp_evt_log_events.length: "+_temp_evt_log_events.length);if(TS.shouldLog(866))console.profile("rxn records");var now=Date.now();for(i=0;i<_temp_evt_log_events.length;i++){imsg=_temp_evt_log_events[i];TS.ms.handleMsg(imsg)}_temp_evt_log_events.length=0;if(TS.shouldLog(866))console.profileEnd();TS.log(866,"TS.ms.handleMsg: "+(Date.now()-now));_updateUIThrottled.always_wait=false;_dispatchSignalThrottled.always_wait=false}};var _backFillRxnRecords=function(start){if(!start){var days_ago=Math.min(29,parseInt(TS.qs_args.rxn_record_days)||7);var ms_ago=1e3*60*60*24*days_ago;start=Math.round((Date.now()-ms_ago)/1e3)}TS.api.call("eventlog.history",{start:start,count:TS.boot_data.version_ts=="dev"?200:2e3},_onEventLog)};var _displayTooManyError=function(error){if(error==TOO_MANY_REACTIONS){TS.generic_dialog.alert("You can only add up to 10 reactions to a message.","Reaction Limit Reached")}else if(error==TOO_MANY_EMOJI){TS.generic_dialog.alert("A message can contain up to 50 different emojis in its reactions. Sorry, you can’t add any more than this!","Reaction Limit Reached")}else{return}};var TOO_MANY_REACTIONS="too_many_reactions";var TOO_MANY_EMOJI="too_many_emoji";var INVALID_NAME="invalid_name"})();
