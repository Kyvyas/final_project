(function(){"use strict";TS.registerModule("ui.filter_select",{onStart:function(){$("select[data-filter-select], label[data-filter-select] select").addClass("hidden").filterSelect()},make:function($select,settings){if($select.prop("tagName")==="SELECT"){if(typeof settings.single==="undefined"){settings.single=!$select.prop("multiple")}}var instance=$.extend({},_DEFAULT_SETTINGS,settings);var $container=$('<div class="filter_select">');if(instance.classes){$container.addClass(instance.classes)}if(instance.default_style){$container.addClass("default_style")}if(instance.single){$container.addClass("single")}if($select.prop("disabled"))instance.disabled=true;if(instance.disabled)$container.addClass("disabled");$container.html(TS.templates.filter_select_container({instance:instance}));if(instance.append){$container.appendTo($select)}else{$container.insertAfter($select)}instance.$container=$container;instance.$input_container=$container.find(".fsl_input_container");instance.$list_container=$container.children(".fsl_list_container");instance.$scroller=$container.find(".fsl_scroller");instance.$list=$container.find(".fsl_list");instance.$input=$container.find(".fsl_input");instance.$value=$container.find(".fsl_value");instance.$select=$select;instance.update=function(data){instance.data=data||_processSelect($select);instance._selected=[];_processIndices(instance);_processPreselected(instance);_populate(instance)};instance.update(instance.data);_bindUI(instance);if(instance.always_visible)_showList(instance);return instance},getValue:function(instance){return instance._selected}});var _DEFAULT_SETTINGS={template:function(item){var text=item.toString();var addl_text;if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();addl_text=TS.utility.htmlEntities($(item).attr("data-additional-search-field"))}text=TS.utility.htmlEntities(text);if(addl_text){text+=' <span class="addl_text">'+addl_text+"</span>"}return new Handlebars.SafeString(text)},filter:function(item,query){var text=item.toString();query=query.toLowerCase();if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();var addl_text=$(item).attr("data-additional-search-field");if(addl_text&&addl_text.toLowerCase().indexOf(query)!==-1)return true}return text.toLowerCase().indexOf(query)!==-1},paginateTemplate:function(page,num_pages,per_page){return TS.templates.filter_select_pagination({page:page,num_pages:num_pages,per_page:per_page})},noResultsTemplate:function(query){return"No items matched <strong>"+TS.utility.htmlEntities(query)+"</strong>"},disabled:false,default_style:true,paginate:true,per_page:300,append:false,placeholder_text:"Type to filter",single:false,monkey_scroll:true,set_height:true,always_visible:false,tab_to_nav:false,onItemAdded:function(item){},onItemRemoved:function(item){},onKeyDown:function(e,handled){},_$active:null,_list_visible:false,_prevent_blur:false,_dimensions_set:false,_previous_val:"",_page:1,_num_pages:1,_current_data:null};var _mouse={};var _populate=function(instance,data){if(!data)data=instance.data;if(data.length===0){instance.$list_container.addClass("empty");instance.$list.empty();if(instance.$pagination)instance.$pagination.remove();instance.$list.html(instance.noResultsTemplate(instance.$input.val()));instance._$active=null;_updateMonkeyScroll(instance);return}instance.$list_container.removeClass("empty");instance._current_data=data;var start=(instance._page-1)*instance.per_page;instance._num_pages=Math.max(1,Math.ceil(data.length/instance.per_page));data=data.slice(start,start+instance.per_page);var builder="";var marked_active_item=[false];for(var i=0;i<data.length;i++){var item=data[i];var index;if(item.fsl_group){builder+=_buildGroup(item);for(var g=0;g<item.children.length;g++){var subitem=item.children[g];index=subitem.fsl_index.join(",");builder+=_buildItem(instance,subitem,marked_active_item,index,true)}}else{index=item.fsl_index.join(",");builder+=_buildItem(instance,item,marked_active_item,index,false)}}if(instance.$list)instance.$list.empty();if(instance.$pagination)instance.$pagination.remove();instance.$list.html(builder);var $pagination=instance.$pagination=$(instance.paginateTemplate(instance._page,instance._num_pages,instance.per_page));instance.$scroller.append($pagination);if(instance._previous_val!==""){instance._$active=instance.$list.find(".fsl_item.active")}else{instance._$active=null}_updateMonkeyScroll(instance);instance.$scroller.scrollTop(0)};var _buildItem=function(instance,item,marked_active_item,index,in_group,token){var selected=item.fsl_selected;var disabled=item.disabled||item.fsl_disabled;var active=instance._previous_val!==""&&!marked_active_item[0]&&!selected&&!disabled;if(active)marked_active_item[0]=true;var inner_content=instance.template(item);return TS.templates.filter_select_item({content:inner_content,active:active,selected:selected,disabled:disabled,index:index,in_group:in_group,token:token})};var _buildGroup=function(group){var label=TS.utility.htmlEntities(group.label);return'<div class="fsl_group">'+label+"</div>"};var _updateMonkeyScroll=function(instance){if(instance.monkey_scroll&&instance.$scroller.data("monkeyScroll")){_computeHeight(instance);instance.$scroller.data("monkeyScroll").updateFunc()}};var _processIndices=function(instance){var data=instance.data;for(var i=0;i<data.length;i++){var item=data[i];if(item.fsl_group){for(var g=0;g<item.children.length;g++){var index=[i,g];item.children[g].fsl_index=index}}else{item.fsl_index=[i]}}};var _processPreselected=function(instance){var builder="";var data=instance.data;var token=!instance.single;for(var i=0;i<data.length;i++){var item=data[i];var index;if(item.fsl_group){for(var g=0;g<item.children.length;g++){var subitem=item.children[g];if(!(subitem.preselected||subitem.selected))continue;subitem.fsl_selected=true;instance._selected.push(subitem);index=subitem.fsl_index.join(",");builder+=_buildItem(instance,subitem,false,index,true,token);if(instance.single)break}}else{if(!(item.preselected||item.selected))continue;item.fsl_selected=true;instance._selected.push(item);index=item.fsl_index.join(",");builder+=_buildItem(instance,item,false,index,false,token);if(instance.single)break}}if(builder.length>0){instance.$container.addClass("value");if(instance.single){instance.$value.html(builder)}else{$(builder).insertBefore(instance.$input);instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}};var _processSelect=function($select){var $children=$select.children("option, optgroup");var data=[];$children.each(function(){if($(this).prop("tagName")==="OPTGROUP"){var children=$(this).children("option");if($(this).prop("disabled")){children=children.map(function(){this.fsl_disabled=true;return this})}data.push({fsl_group:true,label:$(this).prop("label"),children:children})}else{data.push(this)}});return data};var _select=function(instance,direction){if(instance.disabled)return;if(!instance._list_visible){_showList(instance);return}var $to_select;if(!instance._$active){$to_select=instance.$list.find(".fsl_item:not(.selected, .disabled)").first()}else{$to_select=instance._$active[direction](".fsl_item:not(.selected, .disabled)").first()}if($to_select.length){$to_select.scrollintoview({duration:0});if(instance._$active)instance._$active.removeClass("active");$to_select.addClass("active");instance._$active=$to_select}};var _selectDown=function(instance){return _select(instance,"nextAll")};var _selectUp=function(instance){return _select(instance,"prevAll")};var _addSelected=function(instance,select_next){if(instance.disabled)return;var $active=instance._$active;if(!$active.length)return;if(!_selectable($active))return;if(instance.single&&instance._selected.length){instance._selected[0].fsl_selected=false;instance._selected.length=0;instance.$value.empty();instance.$list.find(".selected").removeClass("selected")}var data_item=_getData(instance,$active);data_item.fsl_selected=true;instance._selected.push(data_item);_updateVal(instance);$active.addClass("selected");$active.removeClass("active");instance._$active=null;var $token;if($.isFunction(instance.tokenTemplate)){var token_html=TS.templates.filter_select_item({content:instance.tokenTemplate(data_item),index:$active.attr("data-index"),token:true});$token=$(token_html)}else{$token=$active.clone()}if(instance.single){$token.appendTo(instance.$value)}else{$token.addClass("fsl_token");$token.insertBefore(instance.$input)}if(!instance.single){instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}instance.$container.addClass("value");if(select_next)_selectDown(instance);instance.onItemAdded(data_item);instance.$input.focus()};var _removeSelected=function(instance,$token){if(instance.disabled)return;var data_item=_getData(instance,$token);data_item.fsl_selected=false;instance._selected=instance._selected.filter(function(item){if(item!==data_item)return true});_updateVal(instance);var $list_item=instance.$list.find('[data-index="'+$token.attr("data-index")+'"]');$list_item.removeClass("selected");if(instance.$input.val().length+instance._selected.length===0){instance.$input_container.addClass("empty");instance.$input.prop("placeholder",instance.placeholder_text)}$token.remove();if(instance._selected.length===0)instance.$container.removeClass("value");instance.onItemRemoved(data_item)};var _removeLastSelected=function(instance){var $token=instance.$input_container.find(".fsl_token").last();if($token.length)_removeSelected(instance,$token)};var _updateVal=function(instance){if(instance.append)return;var values=instance._selected.map(function(item){if(item instanceof HTMLOptionElement){return $(item).val()}});instance.$select.val(values).trigger("change")};var _selectable=function($item){return!($item.hasClass("selected")||$item.hasClass("disabled"))};var _getData=function(instance,$item){var index=$item.attr("data-index").split(",").map(function(i){return parseInt(i,10)});var data=instance.data;switch(index.length){case 1:return data[index[0]];case 2:return data[index[0]].children[index[1]]}return null};var _hideList=function(instance,force){if(!force&&(!instance._list_visible||instance.always_visible||instance.disabled))return;instance._list_visible=false;instance.$list_container.removeClass("visible");instance.$container.removeClass("list_visible");instance.$input_container.removeClass("active")};var _showList=function(instance){if(instance.disabled)return;setTimeout(function(){instance.$input.focus()},0);if(instance._list_visible)return;instance._list_visible=true;instance.$list_container.addClass("visible");instance.$container.addClass("list_visible");instance.$input_container.addClass("active");if(instance.single){instance.$input.val("");instance._previous_val="";instance.$input.focus();_populate(instance)}if(!instance._dimensions_set&&instance.set_height){_computeHeight(instance);if(instance.monkey_scroll)instance.$scroller.monkeyScroll();instance._dimensions_set=true}};var _computeHeight=function(instance){var list_height=instance.$list.height();var container_height=instance.$list_container.height();var padding=instance.$list_container.outerHeight()-container_height;var max_height=parseInt(instance.$list_container.css("max-height"),10);if(isNaN(max_height))max_height=container_height;max_height=max_height-padding;instance.$scroller.css({"max-height":Math.min(list_height,max_height)})};var _filterGroup=function(instance,query){var data=instance.data;var filtered=[];for(var i=0;i<data.length;i++){var item=data[i];if(item.fsl_group){var filtered_children=[];for(var j=0;j<item.children.length;j++){var subitem=item.children[j];if(instance.filter(subitem,query)){filtered_children.push(subitem)}}if(filtered_children.length>0){filtered.push({fsl_group:true,label:item.label,children:filtered_children})}}else{if(instance.filter(item,query)){filtered.push(item)}}}return filtered};var _disable=function(instance){if(instance.disabled)return;instance.disabled=true;instance.$container.addClass("disabled")};var _enable=function(instance){if(!instance.disabled)return;instance.disabled=false;instance.$container.removeClass("disabled")};var _bindUI=function(instance){instance.$input.on("input",function(){if(instance.disabled)return;var query=$(this).val();if(query==instance._previous_val)return;instance._previous_val=query;_showList(instance);var filtered=_filterGroup(instance,query);instance._page=1;_populate(instance,filtered);if(!instance.single){$(this).prop("size",$(this).val().length+1);if($(this).val().length+instance._selected.length===0){instance.$input_container.addClass("empty");instance.$input.prop("placeholder",instance.placeholder_text)}else{instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}});instance.$input.on("keydown",function(e){if(instance.disabled)return;e.stopPropagation();switch(e.keyCode){case TS.utility.keymap.down:e.preventDefault();_selectDown(instance);break;case TS.utility.keymap.up:e.preventDefault();_selectUp(instance);break;case TS.utility.keymap.enter:if(instance._$active&&instance._$active.length&&instance._list_visible){e.preventDefault();_addSelected(instance,false);if($(this).val()!==""){$(this).val("");instance._previous_val="";_populate(instance)}_hideList(instance)}break;case TS.utility.keymap.del:if($(this).val()===""){e.preventDefault();_removeLastSelected(instance)}break;case TS.utility.keymap.tab:if(instance.tab_to_nav){e.preventDefault();if(e.shiftKey){_selectUp(instance)}else{_selectDown(instance)}}break;case TS.utility.keymap.esc:e.preventDefault();_hideList(instance);instance.$input.blur();break}instance.onKeyDown(e,e.isDefaultPrevented())});instance.$input.on("blur",function(){if(!instance._prevent_blur){_hideList(instance)}});instance.$value.on("click",function(e){if(instance.disabled)return;e.stopPropagation();_showList(instance);instance._prevent_blur=false});instance.$value.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$list_container.on("mousemove",".fsl_item",function(e){if(instance.disabled)return;if(e.clientX==_mouse.lastX&&e.clientY==_mouse.lastY)return;if(instance._$active)instance._$active.removeClass("active");if(!$(this).hasClass("active")&&_selectable($(this))){$(this).addClass("active");instance._$active=$(this)}_mouse.lastX=e.clientX;_mouse.lastY=e.clientY});instance.$list_container.on("mouseleave",".fsl_item.active",function(e){$(this).removeClass("active");instance._$active=null});instance.$list_container.on("click",".fsl_item",function(e){if(instance.disabled)return;e.preventDefault();if(!_selectable($(this))){return}instance._$active=$(this);_addSelected(instance);if(instance.$input.val()!==""){instance.$input.val("");instance._previous_val="";_populate(instance)}if(instance.single){_hideList(instance);e.stopPropagation()}instance._prevent_blur=false});instance.$list_container.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$input_container.on("focus",function(){instance.$input_container.click();instance.$input.focus()});instance.$input_container.on("click",".fsl_token",function(e){if(instance.disabled)return;_removeSelected(instance,$(this));instance._prevent_blur=false});instance.$input_container.on("mousedown",".fsl_token",function(e){if(e.which===1)instance._prevent_blur=true});instance.$container.on("mouseleave",function(e){instance._prevent_blur=false});instance.$container.on("click",function(e){if(instance.disabled)return;_showList(instance)});instance.$list_container.on("click",".fsl_paginate_back",function(e){if(instance._page>1){instance._page--;_populate(instance,instance._current_data);instance.$input.focus()}});instance.$list_container.on("click",".fsl_paginate_forward",function(e){if(instance._page<instance._num_pages){instance._page++;_populate(instance,instance._current_data);instance.$input.focus()}});instance.$container.parents("label").on("click",function(e){if(instance.disabled)return;e.preventDefault();_showList(instance)})};$.widget("TS.filterSelect",{_create:function(){this.instance=TS.ui.filter_select.make(this.element,this.options)},_destroy:function(){this.instance.$container.remove();delete this.instance},value:function(){return this.instance._selected},setValue:function(val){var prev_selected_index=this.element[0].selectedIndex;while(this.instance.$input_container.find(".fsl_token").length>0){_removeLastSelected(this.instance)}this.element.val(val);if(this.element[0].selectedIndex<0){this.element[0].selectedIndex=0}var selected_option=this.element[0].options[this.element[0].selectedIndex];if(this.element[0].selectedIndex==prev_selected_index){return}var data_index=selected_option.fsl_index;this.instance.$container.find('.fsl_item[data-index="'+data_index+'"]').trigger("click")},getInstance:function(){return this.instance},container:function(){return this.instance.$container},recomputeHeight:function(){_updateMonkeyScroll(this.instance)},showList:function(){_showList(this.instance)},hideList:function(){_hideList(this.instance,true)},update:function(){this.instance.update()},disable:function(){_disable(this.instance)},enable:function(){_enable(this.instance)},disabled:function(){return this.instance.disabled}})})();
